\documentclass{beamer}

\newcommand{\cmd}[1]{\textbf{\texttt{#1}}}
\newcommand{\pkg}[1]{\texttt{#1}}
\newcommand{\env}[1]{\texttt{#1}}
\newcommand{\opt}[1]{\textsl{#1}}

\include{common}
\usepackage{array}
\usepackage{tikz}
\usetikzlibrary{arrows.meta,calc,decorations.markings,matrix,bending}

\newcommand*{\abox}[1]{\framebox{\hbox to 0.5cm{\texttt\{{\\hss#1\hss}}}}

\newenvironment{conditions}
  {\par\vspace{\abovedisplayskip}\noindent\begin{tabular}{>{$}l<{$} @{${}={}$} l}}
  {\end{tabular}\par\vspace{\belowdisplayskip}}

\title{Multi-dimensional Arrays}
\author{Roger Leigh}
\date{April 2016}

\begin{document}

\begin{frame}[plain,fragile]
  \titlepage
  \begin{center}

    \begin{tikzpicture}
      \matrix(m)[column sep=0pt,every node/.style={inner sep=1.5ex,text depth=0.5ex,text height=1.5ex,anchor=center}]
              {
                \node(m0) {a}; & \node(m1) {r}; & \node(m2) {r}; & \node(m3) {a}; & \node(m4) {y}; & \node(m5) {s}; \\
              };
              \draw[thick](m0.north west)--(m5.north east);
              \draw[thick](m0.south west)--(m5.south east);
              \draw[thick](m0.north west)--(m0.south west);
              \draw[thick](m0.north east)--(m0.south east);
              \draw[thick](m1.north east)--(m1.south east);
              \draw[thick](m2.north east)--(m2.south east);
              \draw[thick](m3.north east)--(m3.south east);
              \draw[thick](m4.north east)--(m4.south east);
              \draw[thick](m5.north east)--(m5.south east);

    \end{tikzpicture}
\\
  \end{center}
\end{frame}

\section[]{Overview}
\frame{
\frametitle{Overview}
\tableofcontents
}

\begin{frame}[fragile]
  \frametitle{Addressing: One dimension}

  \begin{center}

  \begin{tikzpicture}[y=-1cm]
    \foreach \x in {0,1,2,3,4,5}
      \draw[gray,thick] (\x,0) rectangle (\x+1,1);
    \draw[black,very thick] (0,0) rectangle (6,1);
    \foreach \x in {0,1,2,3,4,5}
      \draw (\x+0.5, 0.5) node[black!50!blue] {\x};
    \draw (0, 0.5) node[anchor=east,black!50!blue] {Index};

    \onslide<2->{
    \foreach \x in {0,1,2,3,4,5}
      \draw[gray,thick] (\x,1) rectangle (\x+1,2);
    \draw[black,very thick] (0,1) rectangle (6,2);
    \foreach \x in {0,1,2,3,4,5}
      \draw (\x+0.5, 1.5) node[black!50!green] {\x};
    \draw (0, 1.5) node[anchor=east,black!50!green] {Offset};
    }
    \onslide<3->{
    \draw [-{Latex[scale=1.5]}, thick, black!30!red] (0.5,2.6) -- (0.5,2);   
    \draw (0.5,2.5) node[anchor=north, black!30!red] {base=0};

    \draw [-{Latex[scale=1.5,flex=1]}, thick, black!30!red] (3.5,2) arc[radius=0.5, start angle=-180, end angle=-360];
    \draw (4,2.5) node[anchor=north, black!30!red] {stride=1};
    }
  \end{tikzpicture}

  \onslide<4->{
  \begin{equation*}
    \mathrm{Offset} = \mathrm{base} + (\mathrm{Index} \cdot \mathrm{stride})
  \end{equation*}
  \begin{equation*}
    \mathrm{Offset} = \mathrm{Index}
  \end{equation*}
  }
  \end{center}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Addressing: One dimension (reversed)}
  
  \begin{center}
  \begin{tikzpicture}[y=-1cm]
    \foreach \x in {0,1,2,3,4,5}
      \draw[gray,thick] (\x,0) rectangle (\x+1,1);
    \draw[black,very thick] (0,0) rectangle (6,1);
    \foreach \x in {0,1,2,3,4,5}
      \draw (\x+0.5, 0.5) node[black!50!blue] {\x};
    \draw (0, 0.5) node[anchor=east,black!50!blue] {Index};

    \foreach \x in {0,1,2,3,4,5}
      \draw[gray,thick] (\x,1) rectangle (\x+1,2);
    \draw[black,very thick] (0,1) rectangle (6,2);
    \foreach \x in {0,1,2,3,4,5}
      \draw[black!50!green] node at (\x+0.5, 1.5) {%
    \pgfmathparse{5-\x}%
    \pgfmathprintnumber[assume math mode=true]{\pgfmathresult}%
    };
    \draw (0, 1.5) node[anchor=east,black!50!green] {Offset};

    \draw [-{Latex[scale=1.5]}, thick, black!30!red] (5.5,2.6) -- (5.5,2);   
    \draw (5.5,2.5) node[anchor=north, black!30!red] {base=5};

    \draw [-{Latex[scale=1.5,flex=1]}, thick, black!30!red] (2.5,2) arc[radius=0.5, start angle=-360, end angle=-180];
    \draw (2,2.5) node[anchor=north, black!30!red] {stride=-1};
  \end{tikzpicture}

  \onslide<2->{
  \begin{equation*}
    \mathrm{Offset} = \mathrm{base} + (\mathrm{Index} \cdot \mathrm{stride})
  \end{equation*}
  \begin{equation*}
    \mathrm{Offset} = 5 + (\mathrm{Index} \cdot -1)
  \end{equation*}
  \begin{equation*}
    \mathrm{Offset} = 5 - \mathrm{Index}
  \end{equation*}
  }
  \end{center}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Addressing: Two dimensions (row-major)}

  \begin{center}

  \begin{tikzpicture}[y=-1cm]
    \foreach \x in {0,1,2,3,4}
      \draw[gray,thick] (\x,-1) rectangle (\x+1,0);
    \foreach \y in {0,1,2}
      \draw[gray,thick] (-1,\y) rectangle (0,\y);
    \draw[black,very thick] (0,-1) rectangle (5,0);
    \draw[black,very thick] (-1,0) rectangle (0,3);
    \draw[black,very thick] (0,0) rectangle (5,3);
    \foreach \x in {0,1,2,3,4}
      \draw (\x+0.5, -0.5) node[black!50!blue] {\x};
    \foreach \y in {0,1,2}
      \draw (-0.5,\y+0.5) node[black!50!blue] {\y};
    \draw (2.5, -1) node[anchor=south,black!50!blue] {x Index};
    \draw (-1, 1.5) node[anchor=east,black!50!blue] {\rotatebox{90}{y Index}};

    \onslide<2->{
    \foreach \x in {0,1,2,3,4}
      \foreach \y in {0,1,2} {
        \draw[gray,thick] (\x,\y) rectangle (\x+1,\y+1);
        \draw[black!50!green] node at (\x+0.5, \y+0.5) {%
          \pgfmathparse{\x+(5*\y)}%
          \pgfmathprintnumber[assume math mode=true]{\pgfmathresult}%
        };
      }
      \draw[black,very thick] (0,0) rectangle (5,3);
      \draw (5, 2.5) node[anchor=west,black!50!green] {Offset};
    }
    \onslide<3->{
    \draw [-{Latex[scale=1.5]}, thick, black!30!red] (-0.5,-0.5) -- (0,0);   
    \draw (-0.5,-0.5) node[anchor=south east, black!30!red] {base=0};

    \draw [-{Latex[scale=1.5,flex=1]}, thick, black!30!red] (0.5,3) arc[radius=0.5, start angle=-180, end angle=-360];
    \draw (1,3.5) node[anchor=north, black!30!red] {x stride=1};

    \draw [-{Latex[scale=1.5,flex=1]}, thick, black!30!red] (5,0.5) arc[radius=0.5, start angle=-90, end angle=90];
    \draw (5.5,1) node[anchor=west, black!30!red] {y stride=5};
    }
  \end{tikzpicture}

  \onslide<4->{
  \begin{equation*}
    \mathrm{Offset} = \mathrm{base} + (\mathrm{Index}_x \cdot \mathrm{stride}_x) + (\mathrm{Index}_y \cdot \mathrm{stride}_y)
  \end{equation*}
  \begin{equation*}
    \mathrm{Offset} = \mathrm{Index}_x + (\mathrm{Index}_y \cdot 5)
  \end{equation*}
  }
  \end{center}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Addressing: Two dimensions (column-major)}

  \begin{center}

  \begin{tikzpicture}[y=-1cm]
    \foreach \x in {0,1,2,3,4}
      \draw[gray,thick] (\x,-1) rectangle (\x+1,0);
    \foreach \y in {0,1,2}
      \draw[gray,thick] (-1,\y) rectangle (0,\y);
    \draw[black,very thick] (0,-1) rectangle (5,0);
    \draw[black,very thick] (-1,0) rectangle (0,3);
    \draw[black,very thick] (0,0) rectangle (5,3);
    \foreach \x in {0,1,2,3,4}
      \draw (\x+0.5, -0.5) node[black!50!blue] {\x};
    \foreach \y in {0,1,2}
      \draw (-0.5,\y+0.5) node[black!50!blue] {\y};
    \draw (2.5, -1) node[anchor=south,black!50!blue] {x Index};
    \draw (-1, 1.5) node[anchor=east,black!50!blue] {\rotatebox{90}{y Index}};

    \foreach \x in {0,1,2,3,4}
      \foreach \y in {0,1,2} {
        \draw[gray,thick] (\x,\y) rectangle (\x+1,\y+1);
        \draw[black!50!green] node at (\x+0.5, \y+0.5) {%
          \pgfmathparse{(\x*3)+\y}%
          \pgfmathprintnumber[assume math mode=true]{\pgfmathresult}%
        };
      }
      \draw[black,very thick] (0,0) rectangle (5,3);
      \draw (5, 2.5) node[anchor=west,black!50!green] {Offset};

    \onslide<2->{
    \draw [-{Latex[scale=1.5]}, thick, black!30!red] (-0.5,-0.5) -- (0,0);   
    \draw (-0.5,-0.5) node[anchor=south east, black!30!red] {base=0};

    \draw [-{Latex[scale=1.5,flex=1]}, thick, black!30!red] (0.5,3) arc[radius=0.5, start angle=-180, end angle=-360];
    \draw (1,3.5) node[anchor=north, black!30!red] {x stride=3};

    \draw [-{Latex[scale=1.5,flex=1]}, thick, black!30!red] (5,0.5) arc[radius=0.5, start angle=-90, end angle=90];
    \draw (5.5,1) node[anchor=west, black!30!red] {y stride=1};
    }
  \end{tikzpicture}

  \onslide<3->{
  \begin{equation*}
    \mathrm{Offset} = \mathrm{base} + (\mathrm{Index}_x \cdot \mathrm{stride}_x) + (\mathrm{Index}_y \cdot \mathrm{stride}_y)
  \end{equation*}
  \begin{equation*}
    \mathrm{Offset} = (\mathrm{Index}_x \cdot 3) + \mathrm{Index}_y
  \end{equation*}
  }
  \end{center}
\end{frame}

\begin{frame}[fragile]
  \frametitle{Addressing: Two dimensions (column-major, yx order)}

  \begin{center}

  \begin{tikzpicture}[y=-1cm]
    \foreach \x in {0,1,2,3,4}
      \draw[gray,thick] (\x,-1) rectangle (\x+1,0);
    \foreach \y in {0,1,2}
      \draw[gray,thick] (-1,\y) rectangle (0,\y);
    \draw[black,very thick] (0,-1) rectangle (5,0);
    \draw[black,very thick] (-1,0) rectangle (0,3);
    \draw[black,very thick] (0,0) rectangle (5,3);
    \foreach \x in {0,1,2,3,4}
      \draw (\x+0.5, -0.5) node[black!50!blue] {\x};
    \foreach \y in {0,1,2}
      \draw (-0.5,\y+0.5) node[black!50!blue] {\y};
    \draw (2.5, -1) node[anchor=south,black!50!blue] {x Index};
    \draw (-1, 1.5) node[anchor=east,black!50!blue] {\rotatebox{90}{y Index}};

    \foreach \x in {0,1,2,3,4}
      \foreach \y in {0,1,2} {
        \draw[gray,thick] (\x,\y) rectangle (\x+1,\y+1);
        \draw[black!50!green] node at (\x+0.5, \y+0.5) {%
          \pgfmathparse{12+(\x*-3)+\y}%
          \pgfmathprintnumber[assume math mode=true]{\pgfmathresult}%
        };
      }
      \draw[black,very thick] (0,0) rectangle (5,3);
      \draw (5, 2.5) node[anchor=west,black!50!green] {Offset};

    \onslide<2->{
    \draw [-{Latex[scale=1.5]}, thick, black!30!red] (-0.5,-0.5) -- (0,0);   
    \draw (-0.5,-0.5) node[anchor=south east, black!30!red] {base=12};

    \draw [-{Latex[scale=1.5,flex=1]}, thick, black!30!red] (4.5,3) arc[radius=0.5, start angle=-360, end angle=-180];
    \draw (4,3.5) node[anchor=north, black!30!red] {x stride=-3};

    \draw [-{Latex[scale=1.5,flex=1]}, thick, black!30!red] (5,0.5) arc[radius=0.5, start angle=-90, end angle=90];
    \draw (5.5,1) node[anchor=west, black!30!red] {y stride=1};
    }
  \end{tikzpicture}

  \onslide<3->{
  \begin{equation*}
    \mathrm{Offset} = \mathrm{base} + (\mathrm{Index}_x \cdot \mathrm{stride}_x) + (\mathrm{Index}_y \cdot \mathrm{stride}_y)
  \end{equation*}
  \begin{equation*}
    \mathrm{Offset} = 12 + (\mathrm{Index}_x \cdot -3) + \mathrm{Index}_y
  \end{equation*}
  }
  \end{center}
\end{frame}


\begin{frame}
  \frametitle{Logical addressing}
  \begin{columns}[c]
    \column{.5\textwidth}
    \begin{block}{Terms}
    \begin{conditions}
      n & Number of dimensions \\
      C & Coordinate \\
      I & Index \\
      S & Stride \\
    \end{conditions}
    \end{block}
    \column{.5\textwidth}
    \begin{block}{Linear index from logical coordinate}
    \begin{equation*}
      I = \sum\limits_{i=0}^{n-1} (S_i \cdot C_i)
    \end{equation*}
    \end{block}
    \begin{block}{Logical coordinate from linear index}
      For each dimension $i$:
      \begin{equation*}
        C_i = \frac{I}{S_i}
      \end{equation*}

      \begin{equation*}
        I = I \operatorname{mod} S_i
      \end{equation*}
    \end{block}
  \end{columns}
\end{frame}

\begin{frame}
  \frametitle{Storage addressing}
  \begin{columns}[c]
    \column{.5\textwidth}
    \begin{block}{Terms}
    \begin{conditions}
      n & Number of dimensions \\
      E & Dimension extent \\
      C & Coordinate \\
      I & Index \\
      S & Stride \\
      O & Base offset \\
    \end{conditions}
    \end{block}
    \begin{block}{Linear index from logical coordinate}
    \begin{equation*}
      I = O + \sum\limits_{i=0}^{n-1} (S_i \cdot C_i)
    \end{equation*}
    \end{block}
    \column{.5\textwidth}
    \begin{block}{Logical coordinate from linear index}
      For each dimension $i$:
      If ascending:
      \begin{equation*}
        C_i = \frac{I}{S_i}
      \end{equation*}
      \begin{equation*}
        I = I \operatorname{mod} S_i
      \end{equation*}
      If descending:
      \begin{equation*}
        C_i = \frac{(E_i \cdot \lvert S_i \rvert) - S_i - 1}{\lvert S_i \rvert}
      \end{equation*}
      \begin{equation*}
        I = I \operatorname{mod} \lvert S_i \rvert
      \end{equation*}
    \end{block}
  \end{columns}
\end{frame}

\begin{frame}
  \frametitle{Storage addressing with subranges}
  \begin{columns}[c]
    \column{.5\textwidth}
    \begin{block}{Terms}
    \begin{conditions}
      n & Number of dimensions \\
      E & Dimension extent \\
      C & Coordinate \\
      I & Index \\
      S & Stride \\
      O & Base offset \\
      B & Subrange start offset \\
    \end{conditions}
    \end{block}
    \begin{block}{Linear index from logical coordinate}
    \begin{equation*}
      I = O + \sum\limits_{i=0}^{n-1} (S_i \cdot (C_i + B_i))
    \end{equation*}
    \end{block}
    \column{.5\textwidth}
    \begin{block}{Logical coordinate from linear index}
      For each dimension $i$:
      If ascending:
      \begin{equation*}
        C_i = \frac{I}{S_i} - B_i
      \end{equation*}
      \begin{equation*}
        I = I \operatorname{mod} S_i
      \end{equation*}
      If descending:
      \begin{equation*}
        C_i = \frac{(E_i \cdot \lvert S_i \rvert) - S_i - 1}{\lvert S_i \rvert} - B_i
      \end{equation*}
      \begin{equation*}
        I = I \operatorname{mod} \lvert S_i \rvert
      \end{equation*}
    \end{block}
  \end{columns}
\end{frame}

\section{Prerequisites}


\appendix

\section[]{Acknowledgements}

\frame{
  \frametitle{Acknowledgements}
  \parbox[t]{0.45\textwidth}{
    \begin{itemize}
    \item OME Team, Dundee
      \begin{itemize}
      \item Jason Swedlow
      \item Jean-Marie Burel
      \item Mark Carroll
      \item Andrew Patterson
      \item …and the rest of the team
      \end{itemize}
    \end{itemize}
  }
  \parbox[t]{0.45\textwidth}{
    \begin{itemize}
    \item Micron, Oxford
      \begin{itemize}
      \item Douglas Russell
      \end{itemize}
    \item Glencoe Software
      \begin{itemize}
      \item Melissa Linkert
      \item Josh Moore
      \end{itemize}
    \end{itemize}
  }

  \begin{center}
    \vcenteredhbox{\includegraphics[width=0.25\textwidth]{ome}} \hfill
    \vcenteredhbox{\includegraphics[width=0.2\textwidth]{dundee}}\hfill
    \vcenteredhbox{\includegraphics[width=0.5\textwidth]{wellcome}}
  \end{center}
}

\end{document}
